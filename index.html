<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sotiio — мои карты</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: #f4f5fb; /* светлый фон, близко к n8n */
    color: #111827;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  .shell {
    min-height: 100%;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 14px 24px;
    border-bottom: 1px solid #d9dce8;
    background: #ffffff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-weight: 800;
    letter-spacing: 0.22em;
    font-size: 12px;
    text-transform: uppercase;
    color: #6b7280;
  }

  .user-tag {
    font-size: 13px;
    color: #4b5563;
  }

  main {
    padding: 24px 24px 40px;
    max-width: 1080px;
    width: 100%;
    margin: 0 auto;
  }

  h1 {
    font-size: 28px;
    margin: 0 0 4px;
    color: #111827;
  }

  .subtitle {
    margin: 0 0 20px;
    color: #6b7280;
    font-size: 14px;
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn-primary {
    padding: 10px 18px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #ff6a3c, #ff914d);
    color: #ffffff;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 6px rgba(248, 113, 113, 0.35);
  }

  .btn-primary:hover {
    filter: brightness(1.05);
  }

  .btn-primary svg {
    width: 16px;
    height: 16px;
  }

  .status {
    font-size: 13px;
    color: #6b7280;
  }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    margin-top: 8px;
  }

  .card {
    background: #ffffff;
    border-radius: 10px;
    padding: 14px 14px 12px;
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(15, 23, 42, 0.02);
  }

  .card h2 {
    font-size: 16px;
    margin: 0;
    color: #111827;
  }

  .card-meta {
    font-size: 12px;
    color: #6b7280;
  }

  .card-footer {
    margin-top: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .btn-secondary {
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: #111827;
    font-size: 13px;
    padding: 5px 12px;
    cursor: pointer;
  }

  .btn-secondary:hover {
    background: #f3f4f6;
  }

  .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    background: #e5f3ff;
    color: #1d4ed8;
  }

  .badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .empty {
    margin-top: 20px;
    font-size: 14px;
    color: #6b7280;
  }
</style>
</head>
<body>
<div class="shell">
  <header>
    <div class="logo">SOTIIO</div>
    <div class="user-tag" id="userTag">User: …</div>
  </header>

  <main>
    <h1>Ваши карты</h1>
    <p class="subtitle">
      Управляйте своими визуализациями. Новые пользователи попадают сюда после входа через лендинг.
    </p>

    <div class="toolbar">
      <button class="btn-primary" onclick="goCreate()">
        <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M11 5v6H5v2h6v6h2v-6h6v-2h-6V5z"/>
        </svg>
        Создать новую карту
      </button>
      <div class="status" id="status">Загружаем список карт...</div>
    </div>

    <section id="cards" class="cards"></section>
    <div id="emptyState" class="empty" style="display:none;">
      Пока карт нет. Нажмите «Создать новую карту», чтобы начать.
    </div>
  </main>
</div>

<script>
  const N8N_MAP_LIST_URL = "https://n8n.sotiio.com/webhook/get_map_list";
  const STORAGE_KEY_USER = "sotiio_user_id";

  function initUserId() {
    const url = new URL(window.location.href);
    const fromQuery = url.searchParams.get("user_id");

    if (fromQuery) {
      // сохраняем user_id в localStorage
      localStorage.setItem(STORAGE_KEY_USER, fromQuery);
      // чистим query (?user_id=...) чтобы не торчал в адресной строке
      url.searchParams.delete("user_id");
      const clean = url.pathname + (url.search ? "?" + url.search : "");
      window.history.replaceState({}, "", clean || "/login");
      return fromQuery;
    }

    const fromStorage = localStorage.getItem(STORAGE_KEY_USER);
    if (fromStorage) {
      return fromStorage;
    }

    // не удалось определить user_id → уходим на лендинг
    window.location.href = "https://sotiio.com";
    return null; // фактически недостижимо, но для читаемости
  }

  function goCreate() {
    window.location.href = "/userstory.html";
  }

  function goOpenMap(mapId) {
    window.location.href = "/viewer.html?map_id=" + encodeURIComponent(mapId);
  }

  async function loadMaps() {
    const statusEl = document.getElementById("status");
    const cardsEl = document.getElementById("cards");
    const emptyEl = document.getElementById("emptyState");
    const userTag = document.getElementById("userTag");

    const userId = initUserId();
    if (!userId) return; // уже ушли на лендинг

    userTag.textContent = "User: " + userId;

    try {
      statusEl.textContent = "Загружаем ваши карты...";
      const resp = await fetch(N8N_MAP_LIST_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ user_id: userId })
      });

      const text = await resp.text();
      let data;
      try {
        data = text ? JSON.parse(text) : [];
      } catch {
        throw new Error("Невалидный JSON от get_map_list");
      }

      const list = Array.isArray(data) ? data : (data.items || []);
      cardsEl.innerHTML = "";

      if (!list || list.length === 0) {
        emptyEl.style.display = "block";
        statusEl.textContent = "Карт не найдено.";
        return;
      }

      emptyEl.style.display = "none";

      list.forEach(item => {
        const mapId = item.map_id || item.id || "unknown";
        const title = item.title || item.name || ("Карта " + mapId);
        const created = item.created_at || item.created || "";
        const status = item.status || "ready";

        const card = document.createElement("article");
        card.className = "card";
        const badgeClass = status === "pending" ? "badge pending" : "badge";
        card.innerHTML = `
          <h2>${escapeHtml(title)}</h2>
          <div class="card-meta">
            id: <code>${escapeHtml(mapId)}</code><br/>
            ${created ? "Создана: " + escapeHtml(created) : ""}
          </div>
          <div class="card-footer">
            <button class="btn-secondary" data-map-id="${mapId}">Открыть</button>
            <span class="${badgeClass}">${escapeHtml(status)}</span>
          </div>
        `;
        const btn = card.querySelector("button");
        btn.addEventListener("click", () => goOpenMap(mapId));
        cardsEl.appendChild(card);
      });

      statusEl.textContent = "Готово.";
    } catch (err) {
      console.warn(err);
      statusEl.textContent = "Ошибка загрузки карт: " + err.message;
    }
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  loadMaps();
</script>
</body>
</html>
