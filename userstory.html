<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio user story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #f6f6f6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow: auto;
    }

    .wrap {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,.08);
      padding: 22px 26px;
      height: auto;
      min-height: 100%;
      position: relative;
    }

    h1 { margin: 6px 0 18px 0; font-size: 22px; color: #1f1f1f; }
    .row { margin: 18px 0; }
    .label { font-weight: 700; margin-bottom: 10px; font-size: 15px; }
    .roles { display: flex; flex-direction: column; gap: 10px; }
    .roles label { display: flex; align-items: center; gap: 10px; font-size: 15px; }
    .text-input { width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; font-family: inherit; }

    .actions { display: flex; justify-content: flex-end; align-items: center; margin-top: 20px; gap: 12px; }
    .primary-btn { background: #ff622b; color: #fff; border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; font-family: inherit; }
    .primary-btn:disabled { background: #ccc; cursor: not-allowed; }
    .muted { font-size: 13px; color: #666; }
    .divider { height: 1px; background: rgba(0,0,0,0.05); border: 0; margin: 20px 0; width: 100%; }

    .loading-overlay {
      position: absolute; inset: 0; background: rgba(255,255,255,0.95);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      border-radius: 12px; z-index: 100;
    }
    .loading-overlay.active { display: flex; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff622b; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .topbar {
      display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 6px;
    }
    .lang-control { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: #333; }
    .lang-control .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
    .lang-control .switch input { display:none; }
    .lang-control .slider { position: absolute; cursor: pointer; inset: 0; background:#ddd; transition:.2s; border-radius: 22px; }
    .lang-control .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background: #fff; transition:.2s; border-radius: 50%; }
    .lang-control input:checked + .slider { background:#ff622b; }
    .lang-control input:checked + .slider:before { transform: translateX(22px); }
    .lang-select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-family: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Создаём вашу карту знаний...</div>
    </div>

    <div class="topbar">
      <h1>Новое исследование</h1>
      <div class="lang-control">
        <span>Auto</span>
        <label class="switch">
          <input type="checkbox" id="langAuto" checked>
          <span class="slider"></span>
        </label>
        <select id="langSelect" class="lang-select" disabled>
          <option value="ru">Русский</option>
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="de">Deutsch</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="label">Я как…</div>
      <div class="roles">
        <label><input type="radio" name="role" value="Novice"> Новичок</label>
        <label><input type="radio" name="role" value="Enthusiast"> Увлекающийся</label>
        <label><input type="radio" name="role" value="Geek"> Гик</label>
        <label><input type="radio" name="role" value="Pro"> Профи</label>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="label">Хочу изучить…</div>
      <input id="subject" class="text-input" placeholder="например: halo, Marvel, AI...">
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="label">Чтобы…</div>
      <input id="goal" class="text-input" placeholder="например: Быстро сориентироваться в теме...">
    </div>

    <div class="actions">
      <button id="submit" class="primary-btn">Отправить</button>
    </div>
  </div>

  <script>
  (function(){
    const submit = document.getElementById('submit');
    const langAuto = document.getElementById('langAuto');
    const langSelect = document.getElementById('langSelect');

    async function detectLang(){
      try {
        const r = await fetch('https://ipapi.co/json/');
        if(!r.ok) return 'en';
        const j = await r.json();
        const cc = j.country_code?.toLowerCase();
        if(['ru','by','kz','kg','ua'].includes(cc)) return 'ru';
        return 'en';
      } catch { return 'en'; }
    }

    (async()=>{
      const lang = await detectLang();
      langSelect.dataset.autoLang = lang;
      langSelect.value = lang;
    })();

    langAuto.addEventListener('change', ()=>{
      langSelect.disabled = langAuto.checked;
    });

    function getLanguageReply(){
      if(langAuto.checked){
        return langSelect.dataset.autoLang || navigator.language || 'en';
      } else {
        return langSelect.value;
      }
    }

    submit.addEventListener('click', async ()=>{
      const role = document.querySelector('input[name="role"]:checked')?.value;
      const subject = document.getElementById('subject').value.trim();
      const goal = document.getElementById('goal').value.trim();

      if(!role || !subject || !goal){
        alert('Заполните все поля');
        return;
      }

      const currentMapId = Date.now().toString();
      const payload = {
        source: 'sotiio_web_survey',
        map_id: currentMapId,
        user_story: {
          "I_as...": role,
          "Want_to_discover_a_universe...": subject,
          "So_that...": [goal],
          "timestamp": new Date().toISOString()
        },
        language_reply: getLanguageReply()
      };

      // ✅ структура запроса восстановлена (убран no-cors)
      fetch('https://n8n.sotiio.com/webhook/us', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.text())
      .then(() => console.log('Отправлено:', payload))
      .catch(err => console.error('Ошибка:', err));
    });
  })();
  </script>
</body>
</html>
