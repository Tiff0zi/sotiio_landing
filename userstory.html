<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio user story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ...все твои стили без изменений... */
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ...весь остальной HTML без изменений... -->
  </div>

  <script>
  (function(){
    const optsBox = document.getElementById('opts');
    const ownInput = document.getElementById('own');
    const addOwnBtn = document.getElementById('addOwn');
    const chips = document.getElementById('chips');
    const status = document.getElementById('status');
    const submit = document.getElementById('submit');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingDetails = document.getElementById('loadingDetails');
    const progressFill = document.getElementById('progressFill');
    const timer = document.getElementById('timer');

    let currentMapId = null;
    let startTime = null;
    let timerInterval = null;

    const roleTexts = {
      "Novice": [ /* ... */ ],
      "Enthusiast": [ /* ... */ ],
      "Geek": [ /* ... */ ],
      "Pro": [ /* ... */ ]
    };

    // --- остальная логика выбора, добавления, таймера и отправки без изменений ---

    submit.addEventListener('click', async ()=>{
      const role = document.querySelector('input[name="role"]:checked')?.value;
      const subject = document.getElementById('subject').value.trim();
      const chosen = Array.from(optsBox.querySelectorAll('.option-card.selected'))
                         .map(x => x.dataset.value);

      if(!role){
        say('Выберите роль.', 'crimson');
        return;
      }
      
      if(!subject){
        say('Укажите тему/вселенную.', 'crimson');
        return;
      }
      
      if(chosen.length === 0){
        say('Выберите хотя бы один вариант в «Чтобы…» или добавьте свой.', 'crimson');
        return;
      }

      currentMapId = mapIdFromNow();
      startTime = new Date();

      submit.disabled = true;
      loadingOverlay.classList.add('active');
      say('');
      
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      const payload = {
        source: 'sotiio_web_survey',
        map_id: currentMapId,
        user_story: {
          "I_as...": role,
          "Want_to_discover_a_universe...": subject,
          "So_that...": chosen,
          timestamp: (new Date()).toISOString()
        }
      };

      fetch('https://n8n.sotiio.com/webhook/us', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(() => {
        loadingDetails.textContent = 'Запрос на создание карты отправлен...';
      })
      .catch((error) => {
        console.warn('Предупреждение при отправке:', error);
      })
      .finally(() => {
        setTimeout(() => {
          loadingDetails.textContent = 'Ожидаем создание карты...';
          
          fetch('https://n8n.sotiio.com/webhook/getmap', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ map_id: currentMapId })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })

          <!-- ✅ вот здесь внесена правка -->
          .then(data => {
            clearInterval(timerInterval);
            loadingOverlay.classList.remove('active');

            // --- Распаковка ответа n8n ---
            const result = data && data.json ? data.json : data;

            if (result && result.map) {
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'map:set', payload: result }, '*');
              }

              setTimeout(() => {
                if (window.parent && window.parent.UI) {
                  window.parent.UI.closeUserStory();
                }
              }, 1000);
            } else {
              say('Карта не была создана. Попробуйте снова.', 'crimson');
              submit.disabled = false;
            }
          })
          .catch(error => {
            clearInterval(timerInterval);
            loadingOverlay.classList.remove('active');
            say('Ошибка при получении карты: ' + error.message, 'crimson');
            submit.disabled = false;
          });
        }, 10000);
      });
    });

    window.addEventListener('beforeunload', () => {
      if (timerInterval) clearInterval(timerInterval);
    });
  })();
  </script>
</body>
</html>
